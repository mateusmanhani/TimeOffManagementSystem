@page "/my-requests"

@using MAG.TOF.Application.CQRS.Queries.GetRequests
@using MAG.TOF.Application.CQRS.Commands.UpdateRequest
@using MAG.TOF.Application.CQRS.Commands.DeleteRequest
@using MAG.TOF.Application.CQRS.Commands.RecallRequest
@using MAG.TOF.Application.DTOs
@using MAG.TOF.Application.Interfaces
@using MAG.TOF.Domain.Entities
@using MAG.TOF.Domain.Enums
@using MAG.TOF.Web.Components.Dialogs
@using MediatR
@using MudBlazor;

@inject ISnackbar Snackbar;
@inject IExternalDataCache ExternalDataCache;
@inject IMediator Mediator;
@inject IDialogService DialogService;
@inject AuthenticationStateProvider AuthenticationStateProvider;

<PageTitle>Manager Dashboard</PageTitle>

<MudContainer MaxWidth="MaxWidth.ExtraLarge" Class="mt-4">
    <MudText Typo="Typo.h4" GutterBottom="true" Class="mt-4"> DashBoard</MudText>

    @* User Selection Dropdown*@
    <MudPaper MaxWidth="MaxWidth.ExtraLarge" Class="mt-4 mb-4" Elevation="3">
        <MudSelect Value="_selectedUserId"
                   ValueChanged="OnUserSelected"
                   Label="Select User"
                   Variant="Variant.Outlined"
                   T="int?"
                   Placeholder="Choose an user to view their requests"
                   Disabled="_isLoading">
            @if (_managers != null)
            {
                @foreach (var user in _users)
                {
                    <MudSelectItem Value="@((int?)user.Id)">@user.FullName</MudSelectItem>
                }
            }
        </MudSelect>
    </MudPaper>


    <MudGrid Class="mb-6">
        <MudItem xs="12" sm="6" md="3">
            <MudPaper Class="@GetCardClass(RequestStatus.Draft)"
                      Elevation="@(_selectedStatus == RequestStatus.Draft ? 8 : 3)"
                      Style="cursor:pointer"
                      Clickable="true"
                      @onclick="@(async (Microsoft.AspNetCore.Components.Web.MouseEventArgs __e) => await OnCardSelected(RequestStatus.Draft))">
                <MudIcon Icon="@Icons.Material.Filled.HourglassEmpty"
                         Color="Color.Info"
                         Size="Size.Large"
                         Class="mr-4 align-self-center" />
                <div>
                    <MudText Typo="Typo.h4">@_draftCount</MudText>
                    <MudText Typo="Typo.body1" Color="Color.Info"><b>Drafts</b></MudText>
                </div>
            </MudPaper>
        </MudItem>

        <MudItem xs="12" sm="6" md="3">
            <MudPaper Class="@GetCardClass(RequestStatus.Approved)"
                      Elevation="@(_selectedStatus == RequestStatus.Approved ? 8 : 3)"
                      Style="cursor:pointer"
                      Clickable="true"
                      @onclick="@(async (Microsoft.AspNetCore.Components.Web.MouseEventArgs __e) => await OnCardSelected(RequestStatus.Approved))">
                <MudIcon Icon="@Icons.Material.Filled.CheckCircle"
                         Color="Color.Success"
                         Size="Size.Large"
                         Class="mr-4 align-self-center" />
                <div>
                    <MudText Typo="Typo.h4">@_approvedCount</MudText>
                    <MudText Typo="Typo.body1" Color="Color.Success"><b>Approved</b></MudText>
                </div>
            </MudPaper>
        </MudItem>

        <MudItem xs="12" sm="6" md="3">
            <MudPaper Class="@GetCardClass(RequestStatus.Rejected)"
                      Elevation="@(_selectedStatus == RequestStatus.Rejected ? 8 : 3)"
                      Style="cursor:pointer"
                      Clickable="true"
                      @onclick="@(async (Microsoft.AspNetCore.Components.Web.MouseEventArgs __e) => await OnCardSelected(RequestStatus.Rejected))">
                <MudIcon Icon="@Icons.Material.Filled.Cancel" Color="Color.Error" Size="Size.Large" Class="mr-4 align-self-center" />
                <div>
                    <MudText Typo="Typo.h4">@_rejectedCount</MudText>
                    <MudText Typo="Typo.body1" Color="Color.Error"><b>Rejected</b></MudText>
                </div>
            </MudPaper>
        </MudItem>

        <MudItem xs="12" sm="6" md="3">
            <MudPaper Class="@GetCardClass(RequestStatus.Pending)"
                      Elevation="@(!_selectedStatus.HasValue ? 8 : 3)"
                      Style="cursor:pointer"
                      Clickable="true"
                      @onclick="@(async (Microsoft.AspNetCore.Components.Web.MouseEventArgs __e) => await OnCardSelected(RequestStatus.Pending))">
                <MudIcon Icon="@Icons.Material.Filled.CalendarToday" Color="Color.Primary" Size="Size.Large" Class="mr-4 align-self-center" />
                <div>
                    <MudText Typo="Typo.h4">@_pendingCount</MudText>
                    <MudText Typo="Typo.body1" Color="Color.Primary"><b>Pending</b></MudText>
                </div>
            </MudPaper>
        </MudItem>
    </MudGrid>

    <MudText Typo="Typo.h5" Class="mb-2">Recent Requests</MudText>

    @if (_isLoading)
    {
        <MudPaper Class="pa-6 d-flex justify-center" Elevation="3">
            <MudProgressCircular Indeterminate="true" Size="Size.Large" />
        </MudPaper>
    }
    else if (_allRequests == null || !_allRequests.Any())
    {
        <MudPaper Class="pa-6" Elevation="3">
            <MudText Typo="Typo.body1" Align="Align.Center">
                @if (!_selectedUserId.HasValue)
                {
                    <span>Please select an user and click "Load Requests"</span>
                }
                else
                {
                    <span>No requests found for the selected user</span>

                }
            </MudText>
        </MudPaper>
    }
    else
    {
        <MudTable Items="@_filteredRequests" Hover="true" Breakpoint="Breakpoint.Sm" Elevation="3">
            <HeaderContent>
                <MudTh>Request ID</MudTh>
                <MudTh>Dates</MudTh>
                <MudTh>Duration</MudTh>
                <MudTh>Manager</MudTh>
                <MudTh>Status</MudTh>
                <MudTh>Actions</MudTh>
            </HeaderContent>

            <RowTemplate>
                <MudTd DataLabel="Request ID">@context.Id</MudTd>
                <MudTd DataLabel="Dates">
                    @context.StartDate.ToString("MMM dd") - @context.EndDate.ToString("MMM dd, yyyy")
                </MudTd>
            <MudTd DataLabel="Duration">@context.TotalBusinessDays Days</MudTd>
                <MudTd DataLabel="Manager">@GetManagerName(context.ManagerId ?? 0)</MudTd>
                <MudTd DataLabel="Status">
                    <MudChip T="string" Color="@GetStatusColor(context.Status)" Size="Size.Small">
                        @context.Status.ToString()
                    </MudChip>
                </MudTd>
                <MudTd DataLabel="Actions">
                    <MudMenu Icon="@Icons.Material.Filled.MoreVert" Size="Size.Small">
                        @if (context.Status == RequestStatus.Draft || context.Status == RequestStatus.Recalled)
                        {
                            <MudMenuItem Icon="@Icons.Material.Filled.Check"
                                         IconColor="Color.Success"
                                         OnClick="@(() => EditRequest(context))">
                                Edit
                            </MudMenuItem>
                            <MudMenuItem Icon="@Icons.Material.Filled.Check"
                                         IconColor="Color.Primary"
                                         OnClick="@(() => SubmitRequest(context))">
                                Submit
                            </MudMenuItem>

                            <MudMenuItem Icon="@Icons.Material.Filled.Close"
                                         IconColor="Color.Error"
                                         OnClick="@(() => DeleteRequest(context))">
                                Delete
                            </MudMenuItem>
                        }
                        else if (context.Status == RequestStatus.Pending)
                        {
                            <MudMenuItem Icon="@Icons.Material.Filled.Check"
                                         IconColor="Color.Primary"
                                         OnClick="@(() => RecallRequest(context))">
                                Recall
                            </MudMenuItem>
                        }
                    </MudMenu>
                </MudTd>
            </RowTemplate>
        </MudTable>
    }
</MudContainer>

    @code {
    private List<UserDto>? _managers;
    private List<UserDto>? _users;
    private int? _selectedUserId;
    List<Request>? _allRequests; // full set for selected user
    List<Request>? _filteredRequests; // displayed (filtered) list
    private bool _isLoading = false;

    private RequestStatus? _selectedStatus = null; // default to "All"

    private string GetCardClass(RequestStatus? status)
    {
        var baseClass = status switch
        {
            RequestStatus.Draft => "d-flex flex-row pa-4 stat-card stat-card-info",
            RequestStatus.Approved => "d-flex flex-row pa-4 stat-card stat-card-success",
            RequestStatus.Rejected => "d-flex flex-row pa-4 stat-card stat-card-error",
            null => "d-flex flex-row pa-4 stat-card stat-card-primary",
            _ => "d-flex flex-row pa-4 stat-card"
        };

        return _selectedStatus == status ? $"{baseClass} selected" : baseClass;
    }

    // Statiscs counters
    private int _draftCount = 0;
    private int _approvedCount = 0;
    private int _rejectedCount = 0;
    private int _pendingCount = 0;

    /// <summary>
    /// Load full request set for the manager, compute statistics and set the displayed list according to current filter.
    /// </summary>
    private async Task LoadAllRequestsForUser(int userId)
    {
        _isLoading = true;
        try
        {
            var result = await Mediator.Send(new GetRequestQuery(UserId: userId, Status: null));

            result.Switch(
                requests =>
                {
                    // store full set
                    _allRequests = requests;

                    // compute counters from full set
                    _draftCount = requests.Count(r => r.Status == RequestStatus.Draft);
                    _approvedCount = requests.Count(r => r.Status == RequestStatus.Approved);
                    _rejectedCount = requests.Count(r => r.Status == RequestStatus.Rejected);
                    _pendingCount = requests.Count(r => r.Status == RequestStatus.Pending);

                    // apply current filter to create displayed list
                    _filteredRequests = _selectedStatus.HasValue
                        ? _allRequests.Where(r => r.Status == _selectedStatus.Value).ToList()
                        : new List<Request>(_allRequests);
                },
                errors =>
                {
                    var errorMessage = string.Join(", ", errors.Select(e => e.Description));
                    Snackbar.Add($"Failed to load requests: {errorMessage}", Severity.Error);

                    _allRequests = new List<Request>();
                    _filteredRequests = new List<Request>();
                    _draftCount = _approvedCount = _rejectedCount = _pendingCount = 0;
                });
        }
        catch (Exception ex)
        {
            Snackbar.Add("An unexpected error occurred while loading requests", Severity.Error);
            _allRequests = new List<Request>();
            _filteredRequests = new List<Request>();
            _draftCount = _approvedCount = _rejectedCount = _pendingCount = 0;
        }
        finally
        {
            _isLoading = false;
        }
    }

    protected override async Task OnInitializedAsync()
    {
        await LoadManagersAsync();
        await LoadUsersAsync();

        // try to detect current user from authentication state and load their requests
        try
        {
            var auth = await AuthenticationStateProvider.GetAuthenticationStateAsync();
            var user = auth.User;
            var idClaim = user?.FindFirst(System.Security.Claims.ClaimTypes.NameIdentifier)?.Value;
            if (!string.IsNullOrWhiteSpace(idClaim) && int.TryParse(idClaim, out var uid))
            {
                // set selected user and load their requests
                _selectedUserId = uid;
                await LoadAllRequestsForUser(uid);
            }
        }
        catch
        {
            // ignore - not critical
        }
    }

    private async Task LoadManagersAsync()
    {
        try
        {
            _managers = await ExternalDataCache.GetManagersAsync();

            if (_managers.Count == 0)
            {
                Snackbar.Add("No managers found in the system", Severity.Warning);
            }
        }
        catch (Exception ex)
        {
            Snackbar.Add("Failed to load managers. Please refresh the page.", Severity.Error);
            _managers = new List<UserDto>();
        }
    }


    private async Task LoadRequestsAsync(int? userId, RequestStatus? status)
    {
        if (!userId.HasValue)
        {
            Snackbar.Add("Please select a manager first", Severity.Warning);
            return;
        }

        _isLoading = true;

        try
        {
            var result = await Mediator.Send(new GetRequestQuery(
                UserId: userId,
                Status: status));

            // Handle ErrorOr result (side-effects only)
            result.Switch(
                requests =>
                {
                    // Success case: store the requests (this method used for filtered loads)
                    _allRequests = requests;

                    // apply current filter (in case _allRequests already contains full set we avoid extra fetch)
                    _filteredRequests = _selectedStatus.HasValue
                        ? _allRequests.Where(r => r.Status == _selectedStatus.Value).ToList()
                        : new List<Request>(_allRequests);

                    // Update statistics from full set if available
                    if (_allRequests != null)
                    {
                        _draftCount = _allRequests.Count(r => r.Status == RequestStatus.Draft);
                        _approvedCount = _allRequests.Count(r => r.Status == RequestStatus.Approved);
                        _rejectedCount = _allRequests.Count(r => r.Status == RequestStatus.Rejected);
                        _pendingCount = requests.Count(r => r.Status == RequestStatus.Pending);
                    }

                    Snackbar.Add($"Loaded {_filteredRequests.Count} requests successfully");
                },
                errors =>
                {
                    // Error case: show error messages
                    var errorMessage = string.Join(", ", errors.Select(e => e.Description));
                    Snackbar.Add($"Failed to load requests: {errorMessage}", Severity.Error);

                    _allRequests = new List<Request>();
                    _filteredRequests = new List<Request>();
                }
            );
        }
        catch (Exception ex)
        {
            Snackbar.Add("An unexpected error occurred. Please try again");

            _allRequests = new List<Request>();
            _filteredRequests = new List<Request>();
        }
        finally
        {
            _isLoading = false;
        }
    }

    private async Task LoadUsersAsync()
    {
        try
        {
            _users = await ExternalDataCache.GetCachedUsersAsync();
        }
        catch (Exception ex)
        {
            Snackbar.Add("Failed to load users data", Severity.Error);
            _users = new List<UserDto>();
        }
    }

    // Edit Request
    private async Task EditRequest(Request request)
    {
        // open edit dialog which will perform the update - dialog component created separately
        var parameters = new DialogParameters
        {
            { "RequestToEdit", request },
            // pass logged user id so handler can validate ownership when updating
            { "LoggedUserId", _selectedUserId }
        };

        var options = new DialogOptions
        {
            CloseOnEscapeKey = true,
            MaxWidth = MaxWidth.Medium,
            FullWidth = true
        };

        var dialog = await DialogService.ShowAsync<EditRequestDialog>("Edit Request", parameters, options);
        var result = await dialog.Result;

        if (!result.Canceled)
        {
            // reload user's requests after successful edit
            if (_selectedUserId.HasValue)
                await LoadAllRequestsForUser(_selectedUserId.Value);
        }
    }

    // submit Request
    private async Task SubmitRequest(Request request)
    {
        if (!_selectedUserId.HasValue)
        {
            Snackbar.Add("Unable to determine current user", Severity.Warning);
            return;
        }

        try
        {
            // Create an update request command passing in the new pending status
            var command = new UpdateRequestCommand(
                LoggedUserId: _selectedUserId.Value,
                RequestId: request.Id,
                StartDate: request.StartDate,
                EndDate: request.EndDate,
                ManagerId: request.ManagerId,
                Status: RequestStatus.Pending
            );

            var result = await Mediator.Send(command);

            // Hande results or erros
            result.Switch(
                success =>
                {
                    Snackbar.Add($"Request {request.Id} submitted", Severity.Success);
                    request.Status = RequestStatus.Pending; // update status in the UI instead of calling the cache again
                    UpdateStatistics();
                    StateHasChanged();
                },
                errors =>
                {
                    var message = string.Join(", ", errors.Select(e => e.Description));
                    Snackbar.Add($"Failed to submit request: {message}", Severity.Error);
                }
            );
        }
        catch (Exception ex)
        {
            Snackbar.Add("An error ocurred while submitting the request", Severity.Error);
        }
    }

    // Recall Request
    private async Task RecallRequest(Request request)
    {
        if (!_selectedUserId.HasValue)
        {
            Snackbar.Add("Unable to determine current user", Severity.Warning);
            return;
        }

        try
        {
            var command = new RecallRequestCommand(LoggedUserId: _selectedUserId.Value, RequestId: request.Id);
            var result = await Mediator.Send(command);

            result.Switch(
                success =>
                {
                    Snackbar.Add($"Request {request.Id} recalled", Severity.Success);
                    request.Status = RequestStatus.Recalled;
                    UpdateStatistics();
                    StateHasChanged();
                },
                errors =>
                {
                    var message = string.Join(", ", errors.Select(e => e.Description));
                    Snackbar.Add($"Failed to recall request: {message}", Severity.Error);
                }
            );
        }
        catch (Exception)
        {
            Snackbar.Add("An unexpected error occurred while recalling the request", Severity.Error);
        }
    }

    // Delete Request
    private async Task DeleteRequest(Request request)
    {
        if (!_selectedUserId.HasValue)
        {
            Snackbar.Add("Unable to determine current user", Severity.Warning);
            return;
        }

        try
        {
            var command = new DeleteRequestCommand(LoggedUserId: _selectedUserId.Value, RequestId: request.Id);
            var result = await Mediator.Send(command);

            result.Switch(
                _ =>
                {
                    Snackbar.Add($"Request {request.Id} deleted", Severity.Success);
                    _allRequests?.Remove(request);
                    _filteredRequests?.Remove(request);
                    UpdateStatistics();
                    StateHasChanged();
                },
                errors =>
                {
                    var message = string.Join(", ", errors.Select(e => e.Description));
                    Snackbar.Add($"Failed to delete request: {message}", Severity.Error);
                }
            );
        }
        catch (Exception)
        {
            Snackbar.Add("An unexpected error occurred while deleting the request", Severity.Error);
        }
    }

    /// <summary>
    /// Updates the statistics cards based on loaded requests
    /// </summary>
    private void UpdateStatistics()
    {
        if (_allRequests == null)
        {
            _draftCount = 0;
            _approvedCount = 0;
            _rejectedCount = 0;
            _pendingCount = 0;
            return;
        }

        _draftCount = _allRequests.Count(r => r.Status == RequestStatus.Draft);
        _approvedCount = _allRequests.Count(r => r.Status == RequestStatus.Approved);
        _rejectedCount = _allRequests.Count(r => r.Status == RequestStatus.Rejected);
        _pendingCount = _allRequests.Count(r => r.Status == RequestStatus.Pending);
    }

    // ============================================
    // EVENT HANDLERS
    // ============================================

    /// <summary>
    /// Event handler triggered when manager selection changes
    /// Automatically loads requests for the selected manager
    /// </summary>
    private async Task OnUserSelected(int? userId)
    {
        _selectedUserId = userId;

        if (userId.HasValue)
        {
            _selectedStatus ??= null;

            // Load full set and compute counts, then displayed filtered list will be set inside
            await LoadAllRequestsForUser(userId.Value);
        }
        else
        {
            // Clear data if selection is cleared
            _allRequests = null;
            _filteredRequests = null;
            _selectedStatus = null;
            UpdateStatistics();
        }
    }

    private async Task OnCardSelected(RequestStatus? status)
    {
        _selectedStatus = status;

        // update displayed list from already loaded full set when possible
        if (_allRequests != null)
        {
            _filteredRequests = _selectedStatus.HasValue
                ? _allRequests.Where(r => r.Status == _selectedStatus.Value).ToList()
                : new List<Request>(_allRequests);

            // update UI immediately
            StateHasChanged();
            return;
        }

        // otherwise load full set for current manager then apply filter
        if (_selectedUserId.HasValue)
        {
            await LoadAllRequestsForUser(_selectedUserId.Value);
            // ensure UI refresh after load
            StateHasChanged();
        }
        else
        {
            Snackbar.Add("Please select a user first", Severity.Warning);
        }
    }

    // ============================================
    // HELPER METHODS
    // ============================================

    /// <summary>
    /// Returns the appropriate color for each request status
    /// Used in the status chip
    /// </summary>
    private Color GetStatusColor(RequestStatus status)
    {
        return status switch
        {
            RequestStatus.Approved => Color.Success,
            RequestStatus.Rejected => Color.Error,
            RequestStatus.Pending => Color.Warning,
            RequestStatus.Draft => Color.Default,
            _ => Color.Info
        };
    }

    private string GetManagerName(int managerId)
    {
        var manager = _managers?.FirstOrDefault(m => m.Id == managerId);
        return manager?.FullName ?? $"Manager {managerId}";
    }
}
