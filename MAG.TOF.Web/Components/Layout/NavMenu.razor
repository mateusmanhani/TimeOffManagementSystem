@using MudBlazor
@implements IDisposable
@inject NavigationManager NavigationManager
@inject ILogger<NavMenu> Logger

<MudNavMenu>
    <!-- New Request Button -->
    <MudButton Variant="Variant.Filled"
               Color="Color.Primary"
               StartIcon="@Icons.Material.Filled.Add"
               FullWidth="true"
               Class="mb-4 mx-2"
               OnClick="@HandleNewRequestClick">
        New Request
    </MudButton>

    <!-- Dashboard -->
    <MudNavLink Href="" Match="NavLinkMatch.All" Icon="@Icons.Material.Filled.Dashboard">
        Dashboard
    </MudNavLink>

    <!-- Requests (Expandable) -->
    <MudNavGroup Title="Requests" Icon="@Icons.Material.Filled.Description" Expanded="true">
        <MudNavLink Href="requests/my" Icon="@Icons.Material.Filled.Person">
            My Requests
        </MudNavLink>
        <MudNavLink Href="requests/team" Icon="@Icons.Material.Filled.Group">
            Team Requests
        </MudNavLink>
    </MudNavGroup>

    <!-- Calendar -->
    <MudNavLink Href="calendar" Icon="@Icons.Material.Filled.CalendarToday">
        Calendar
    </MudNavLink>

    <!-- Reports -->
    <MudNavLink Href="reports" Icon="@Icons.Material.Filled.Assessment">
        Reports
    </MudNavLink>

    <!-- Settings -->
    <MudNavLink Href="settings" Icon="@Icons.Material.Filled.Settings">
        Settings
    </MudNavLink>

    <MudDivider Class="my-4" />

    <!-- Auth Section -->
    <AuthorizeView>
        <Authorized>
            <MudNavLink Href="Account/Manage" Icon="@Icons.Material.Filled.AccountCircle">
                @context.User.Identity?.Name
            </MudNavLink>
            <MudNavLink OnClick="@Logout" Icon="@Icons.Material.Filled.Logout">
                Logout
            </MudNavLink>
        </Authorized>
        <NotAuthorized>
            <MudNavLink Href="Account/Register" Icon="@Icons.Material.Filled.PersonAdd">
                Register
            </MudNavLink>
            <MudNavLink Href="Account/Login" Icon="@Icons.Material.Filled.Login">
                Login
            </MudNavLink>
        </NotAuthorized>
    </AuthorizeView>
</MudNavMenu>

@code {
    [Parameter]
    public EventCallback OnNewRequestClick { get; set; }

    private string? currentUrl;

    protected override void OnInitialized()
    {
        currentUrl = NavigationManager.ToBaseRelativePath(NavigationManager.Uri);
        NavigationManager.LocationChanged += OnLocationChanged;
        Logger.LogInformation("NavMenu initialized. OnNewRequestClick HasDelegate: {HasDelegate}", OnNewRequestClick.HasDelegate);
    }

    private void OnLocationChanged(object? sender, LocationChangedEventArgs e)
    {
        currentUrl = NavigationManager.ToBaseRelativePath(e.Location);
        StateHasChanged();
    }

    private async Task HandleNewRequestClick()
    {
        Logger.LogInformation("New Request button clicked!");
        if (OnNewRequestClick.HasDelegate)
        {
            Logger.LogInformation("Invoking OnNewRequestClick callback");
            await OnNewRequestClick.InvokeAsync();
        }
        else
        {
            Logger.LogWarning("OnNewRequestClick has no delegate attached!");
        }
    }

    private void Logout()
    {
        NavigationManager.NavigateTo("/Account/Logout", forceLoad: true);
    }

    public void Dispose()
    {
        NavigationManager.LocationChanged -= OnLocationChanged;
    }
}

