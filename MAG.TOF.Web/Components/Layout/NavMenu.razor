@using MudBlazor
@implements IDisposable
@inject NavigationManager NavigationManager

<!-- MudBlazor Navigation Menu Component -->
<MudNavMenu Class="pt-0 mt-0">
    
    <!-- Primary Action Button: Create New Request -->
    <!-- When clicked, invokes the callback passed from MainLayout -->
    <MudButton Variant="Variant.Filled"
               Color="Color.Primary"
               StartIcon="@Icons.Material.Filled.Add"
               FullWidth="true"
               Class="mb-4 mx-2"
               OnClick="@HandleNewRequestClick">
        New Request
    </MudButton>

    <!-- Navigation Links -->
    
    <!-- Dashboard - MyRequests -->
    <MudNavLink Href="/my-requests" Match="NavLinkMatch.All" Icon="@Icons.Material.Filled.Dashboard" Class="@(IsHomeActive ? "mud-nav-link-active" : null)">
        My Requests
    </MudNavLink>

    <!-- Manager Dashboard -->
    <MudNavLink Href="manager-dashboard" Icon="@Icons.Material.Filled.SupervisorAccount">
        Manager Dashboard
    </MudNavLink>

    <MudNavLink Href="reports" Icon="@Icons.Material.Filled.Assessment">
        Reports
    </MudNavLink>

    <MudNavLink Href="settings" Icon="@Icons.Material.Filled.Settings">
        Settings
    </MudNavLink>

    <!-- Divider separates main navigation from auth section -->
    <MudDivider Class="my-4" />

    <!-- Authentication Section - Shows different options based on login state -->
    <AuthorizeView>
        <Authorized>
            <!-- User is logged in -->
            <MudNavLink Href="Account/Manage" Icon="@Icons.Material.Filled.AccountCircle">
                @context.User.Identity?.Name
            </MudNavLink>
            <MudNavLink OnClick="@Logout" Icon="@Icons.Material.Filled.Logout">
                Logout
            </MudNavLink>
        </Authorized>
        <NotAuthorized>
            <!-- User is not logged in -->
            <MudNavLink Href="Account/Register" Icon="@Icons.Material.Filled.PersonAdd">
                Register
            </MudNavLink>
            <MudNavLink Href="Account/Login" Icon="@Icons.Material.Filled.Login">
                Login
            </MudNavLink>
        </NotAuthorized>
    </AuthorizeView>
</MudNavMenu>

@code {
    /// <summary>
    /// Event callback passed from MainLayout
    /// Used to notify parent when "New Request" button is clicked
    /// </summary>
    [Parameter]
    public EventCallback OnNewRequestClick { get; set; }

    private string? currentUrl;

    protected override void OnInitialized()
    {
        // Track current URL for navigation highlighting
        currentUrl = NavigationManager.ToBaseRelativePath(NavigationManager.Uri);
        
        // Subscribe to navigation changes to update active link styling
        NavigationManager.LocationChanged += OnLocationChanged;
    }

    private bool IsHomeActive => string.IsNullOrEmpty(currentUrl) || currentUrl.Equals("my-requests", StringComparison.OrdinalIgnoreCase);

    /// <summary>
    /// Updates current URL when user navigates to a different page
    /// Triggers re-render to highlight active navigation link
    /// </summary>
    private void OnLocationChanged(object? sender, LocationChangedEventArgs e)
    {
        currentUrl = NavigationManager.ToBaseRelativePath(e.Location);
        StateHasChanged();
    }

    /// <summary>
    /// Handles "New Request" button click
    /// Invokes the callback to open the right drawer in MainLayout
    /// </summary>
    private async Task HandleNewRequestClick()
    {
        await OnNewRequestClick.InvokeAsync();
    }

    /// <summary>
    /// Logs out the current user
    /// Navigates to logout endpoint with full page reload
    /// </summary>
    private void Logout()
    {
        NavigationManager.NavigateTo("/Account/Logout", forceLoad: true);
    }

    /// <summary>
    /// Cleanup: Unsubscribe from navigation events when component is disposed
    /// </summary>
    public void Dispose()
    {
        NavigationManager.LocationChanged -= OnLocationChanged;
    }
}

