@using MAG.TOF.Application.CQRS.Commands.CreateRequest
@using MAG.TOF.Application.DTOs
@using MAG.TOF.Application.Interfaces
@using MAG.TOF.Domain.Enums
@using MAG.TOF.Domain.Services
@using MediatR
@using MudBlazor

@inject IMediator Mediator
@inject ILogger<CreateRequestForm> Logger
@inject ISnackbar Snackbar
@inject RequestValidationService ValidationService
@inject IExternalDataCache ExternalDataCache

<!-- MudBlazor Form with validation -->
<MudForm @ref="_form">
    <MudStack Spacing="3" Class="pa-4">

        <!-- User and Department Selection Row -->
        <MudGrid>
            <MudItem xs="12" sm="6">
                <MudSelect @bind-Value="model.UserId"
                            Label="User"
                            Variant="Variant.Outlined"
                            Required="true"
                            HelperText="Select the User making the request"
                            T="int?">
                      @if (_users != null)
                      {
                      @foreach (var user in _users)
                      {
                            <MudSelectItem Value="@((int?)user.Id)">@user.FullName</MudSelectItem>
                      }
                    }
                </MudSelect>
            </MudItem>

            <MudItem xs="12" sm="6">
                <MudSelect @bind-Value="model.DepartmentId"
                           Label="Department"
                           Variant="Variant.Outlined"
                           Required="true"
                           HelperText="Select Your Department"
                           T="int?">
                    @if (_departments != null)
                    {
                    @foreach (var department in _departments)
                    {
                        <MudSelectItem Value="@((int?)department.Id)">@department.Name</MudSelectItem>
                    }
                    }
                </MudSelect>
            </MudItem>
        </MudGrid>

        <!-- Date Range Selection -->
        <MudGrid>
            <MudItem xs="12" sm="6">
                <MudDatePicker @bind-Date="startDate"
                               Label="Date From"
                               Variant="Variant.Outlined"
                               MinDate="DateTime.Today"
                               HelperText="Start date cannot be in the past" />
            </MudItem>

            <MudItem xs="12" sm="6">
                <MudDatePicker @bind-Date="endDate"
                               Label="Date To"
                               Variant="Variant.Outlined"
                               MinDate="startDate ?? DateTime.Today"
                               HelperText="End date must be after start date" />
            </MudItem>
        </MudGrid>

        <!-- Business Days Calculation Display -->
        @if (startDate.HasValue && endDate.HasValue)
        {
            var businessDaysText = CalculateBusinessDays();

            @if (businessDaysText == "Invalid")
            {
                <MudAlert Severity="Severity.Warning" Variant="Variant.Outlined">
                    Invalid date range - end date must be after start date
                </MudAlert>
            }
            else
            {
                <MudAlert Severity="Severity.Info" Variant="Variant.Outlined">
                    <strong>Total: @businessDaysText Business Days</strong> (Excluding Weekends)
                </MudAlert>
            }
        }

        <!-- Manager Selection -->
        <MudSelect @bind-Value="model.ManagerId"
                   Label="Approving Manager"
                   Variant="Variant.Outlined"
                   Clearable="true"
                   HelperText="Optional: Select manager for approval routing"
                   T="int?">
            @if (_managers != null)
            {
                @foreach (var manager in _managers)
                {
                    <MudSelectItem Value="@((int?)manager.Id)">@manager.FullName</MudSelectItem>
                }
            }
        </MudSelect>

        <!-- Form Action Buttons -->
        <MudStack Row="true" Justify="Justify.FlexEnd" Spacing="2">
            <!-- Save Draft Button -->
            <MudButton Variant="Variant.Outlined"
                       Color="Color.Default"
                       OnClick="SaveDraft"
                       Disabled="@_isSubmitting">
                Save Draft
            </MudButton>

            <!-- Submit Button - Disabled while form is submitting -->
            <MudButton Variant="Variant.Filled"
                       Color="Color.Primary"
                       OnClick="HandleSubmit"
                       Disabled="@_isSubmitting">
                @if (_isSubmitting)
                {
                    <!-- Show loading indicator during submission -->
                    <MudProgressCircular Size="Size.Small" Indeterminate="true" />
                    <MudText Class="ml-2">Submitting...</MudText>
                }
                else
                {
                    <span>Submit</span>
                }
            </MudButton>
        </MudStack>
    </MudStack>
</MudForm>

@code {
    /// <summary>
    /// Callback invoked when form is successfully submitted
    /// Used by parent (MainLayout) to close the drawer
    /// </summary>
    [Parameter]
    public EventCallback OnSuccess { get; set; }

    // Form references and state
    private MudForm? _form;
    private bool _isSubmitting = false;

    // Form data model
    private RequestFormModel model = new();
    private DateTime? startDate = DateTime.Today;
    private DateTime? endDate = DateTime.Today.AddDays(1);

    // Manager Data from cache
    private List<UserDto>? _managers;

    // Department Data from cache
    private List<DepartmentDto>? _departments;

    // User Data from cache
    private List<UserDto>? _users;

    protected override async Task OnInitializedAsync()
    {
        await LoadManagersAsync();
        await LoadDepartmentsAsync();
        await LoadUsersAsync();
    }

    /// <summary>
    /// Handles form submission
    /// Validates data, sends command to backend via MediatR, handles response
    /// </summary>
    private async Task HandleSubmit()
    {
        _isSubmitting = true;

        try
        {
            if (!model.UserId.HasValue || model.UserId.Value <= 0)
            {
                Snackbar.Add("User is required.", Severity.Warning);
                return;
            }
            if (!model.DepartmentId.HasValue || model.DepartmentId.Value <= 0)
            {
                Snackbar.Add("Department is required.", Severity.Warning);
                return;
            }
            // Create command with form data
            var command = new CreateRequestCommand(
                UserId: model.UserId.Value,
                DepartmentId: model.DepartmentId.Value,
                StartDate: startDate!.Value,
                EndDate: endDate!.Value,
                ManagerId: model.ManagerId,
                Status: RequestStatus.Pending
            );

            // Send command to backend via MediatR (CQRS pattern)
            var result = await Mediator.Send(command);

            // Handle result using ErrorOr pattern
            result.Match(
                requestId =>
                {
                    // Success: Show notification and close drawer
                    Snackbar.Add($"Request created successfully! ID: {requestId}", Severity.Success);
                    ResetForm();
                    OnSuccess.InvokeAsync();  // Notify parent to close drawer
                    return requestId;
                },
                errors =>
                {
                    // Failure: Show error messages
                    var errorMessage = string.Join(", ", errors.Select(e => e.Description));
                    Snackbar.Add(errorMessage, Severity.Error);
                    return 0;
                }
            );
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Unexpected error during request creation");
            Snackbar.Add("An unexpected error occurred. Please try again.", Severity.Error);
        }
        finally
        {
            _isSubmitting = false;
        }
    }

    /// <summary>
    /// Saves the request as a draft with Draft status
    /// </summary>
    private async Task SaveDraft()
    {
        _isSubmitting = true;

        try
        {
            // Validate required fields for draft
            if (!model.UserId.HasValue || model.UserId.Value <= 0)
            {
                Snackbar.Add("User is required.", Severity.Warning);
                return;
            }
            if (!model.DepartmentId.HasValue || model.DepartmentId.Value <= 0)
            {
                Snackbar.Add("Department is required.", Severity.Warning);
                return;
            }

            if (!startDate.HasValue || !endDate.HasValue)
            {
                Snackbar.Add("Start and end dates are required to save a draft.", Severity.Warning);
                return;
            }

            // Create command with Draft status
            var command = new CreateRequestCommand(
                UserId: model.UserId.Value,
                DepartmentId: model.DepartmentId.Value,
                StartDate: startDate!.Value,
                EndDate: endDate!.Value,
                ManagerId: model.ManagerId,
                Status: RequestStatus.Draft
            );

            // Send command to backend via MediatR
            var result = await Mediator.Send(command);

            // Handle result using ErrorOr pattern
            result.Match(
                requestId =>
                {
                    // Success: Show notification
                    Snackbar.Add($"Draft saved successfully! ID: {requestId}", Severity.Success);
                    ResetForm();
                    return requestId;
                },
                errors =>
                {
                    // Failure: Show error messages
                    var errorMessage = string.Join(", ", errors.Select(e => e.Description));
                    Snackbar.Add(errorMessage, Severity.Error);
                    return 0;
                }
            );
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Unexpected error during draft save");
            Snackbar.Add("An unexpected error occurred while saving draft. Please try again.", Severity.Error);
        }
        finally
        {
            _isSubmitting = false;
        }
    }

    private async Task LoadUsersAsync()
    {
        try
        {
            _users = await ExternalDataCache.GetCachedUsersAsync();

            if (_users.Count == 0)
            {
                Logger.LogWarning("No users found in cached data");
                Snackbar.Add("No users found in the system.", Severity.Warning);
            }
        }   
        catch (Exception ex)
        {
            Logger.LogError(ex, "Failed to load users from cache");
            Snackbar.Add("Failed to load users. Please refresh the page.", Severity.Error);
            _users = new List<UserDto>();
        }
    }

    private async Task LoadDepartmentsAsync()
    {
        try
        {
            _departments = await ExternalDataCache.GetCachedDepartmentsAsync();

            if (_departments.Count == 0)
            {
                Logger.LogWarning("No departments found in cached data");
                Snackbar.Add("No departments found in the system.", Severity.Warning);
            }
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Failed to load departments from cache");
            Snackbar.Add("Failed to load departments. Please refresh the page.", Severity.Error);
            _departments = new List<DepartmentDto>();
        }
    }

    private async Task LoadManagersAsync()
    {
        try
        {
            var allUsers = await ExternalDataCache.GetCachedUsersAsync();
            var grades = await ExternalDataCache.GetCachedGradesAsync();

            // Find the managers based on grade
            var managerGrade = grades.
            FirstOrDefault(g => g.Name.Contains("Manager", StringComparison.OrdinalIgnoreCase));

            if (managerGrade == null)
            {
                Logger.LogWarning("Manager grade not found in cached grades");
                _managers = new List<UserDto>();
                return;
            }

            // Filter users by manager grade
            _managers = allUsers
            .Where(u => u.GradeId == managerGrade.Id)
            .OrderBy(u => u.LastName)
            .ToList();

            if (_managers.Count == 0)
            {
                Logger.LogWarning("No managers found in cached users");
                Snackbar.Add("No managers found in the system.", Severity.Warning);
            }
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Failed to load managers from cache");
            Snackbar.Add("Failed to load managers. Please refresh the page.", Severity.Error);
            _managers = new List<UserDto>();
        }
    }

    /// <summary>
    /// Resets form to initial state after successful submission
    /// </summary>
    private void ResetForm()
    {
        model = new RequestFormModel();
        startDate = DateTime.Today;
        endDate = DateTime.Today.AddDays(1);
        _form?.ResetValidation();
    }

    /// <summary>
    /// Calculates business days between selected dates
    /// Uses domain service to ensure consistent calculation logic
    /// </summary>
    private string CalculateBusinessDays()
    {
        if (!startDate.HasValue || !endDate.HasValue)
            return "0";

        try
        {
            // Use domain service for calculation (single source of truth)
            int businessDays = ValidationService.CalculateBusinessDays(
                startDate.Value,
                endDate.Value);
            return businessDays.ToString();
        }
        catch (ArgumentException)
        {
            // Domain service throws if endDate < startDate
            return "Invalid";
        }
    }

    /// <summary>
    /// Form model for data binding
    /// Simplified model with only user input fields
    /// </summary>
    private class RequestFormModel
    {
        public int? UserId { get; set; }
        public int? DepartmentId { get; set; }
        public int? ManagerId { get; set; }
    }
}
